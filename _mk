#!/bin/sh

set -eC

if [ "$1" = "code" ] || [ "$2" = "code" ]; then
	(
		cd _mkcode
		go build mkcode.go
		./mkcode
	)
fi

if [ "$1" != "quick" ] || [ "$2" = "quick" ]; then
	for f in css/*.less; do
		if [  "$f" -nt "${f%.less}.css" ]; then
			echo "lessc $f"
			lessc "$f" |
				sed -E '/^ \*/d; /^\/\*/d; /\*\/$/d; s/^ *//; s/;/; /g' | tr -d '\n' | sed -E 's/; }/;}\n/g' \
				>| "${f%.less}.css"
		fi
	done
fi

JEKYLL_NO_BUNDLER_REQUIRE=1 jekyll build --incremental

if [ "$1" = "deploy" ] || [ "$2" = "deploy" ]; then
	netlify deploy -p _site -s arp242
fi
